version: "2.0"

endpoints:
  metal_endpoint:
    kind: ip

services:
  metal-blockchain:
    image: ubuntu:22.04
    env:
      # Manual IP Override (OPTIONAL): Set METAL_PUBLIC_IP if auto-detection fails
      # 1. Deploy first (get IP assigned from Akash Console)
      # 2. Update this line to: - METAL_PUBLIC_IP=<your-loadbalancer-ip>
      # 3. Update deployment with the modified YAML
      # Or set in Akash Console → Deployment → Environment Variables
      - METAL_PUBLIC_IP=
    command:
      - /bin/bash
      - -c
      - |
        echo 'Installing MetalGo on Ubuntu for MAINNET...'
        apt-get update -o Acquire::http::Pipeline-Depth=0
        apt-get install -y --no-install-recommends wget curl jq ca-certificates
        
        echo 'Downloading MetalGo v1.12.0-hotfix...'
        wget --no-check-certificate -O metalgo.tar.gz \
          https://github.com/MetalBlockchain/metalgo/releases/download/v1.12.0-hotfix/metalgo-linux-amd64-v1.12.0-hotfix.tar.gz
        
        echo 'Extracting MetalGo...'
        tar -xzf metalgo.tar.gz
        mv metalgo-v1.12.0-hotfix/metalgo /usr/local/bin/
        chmod +x /usr/local/bin/metalgo
        rm -rf metalgo-v1.12.0-hotfix metalgo.tar.gz
        
        echo 'Creating data directory...'
        mkdir -p /root/.metalgo
        
        echo 'Setting file descriptor limits...'
        ulimit -n 65536
        echo "File descriptor limit set to: $(ulimit -n)"
        
        echo '========================================='
        echo 'Starting MetalGo node on MAINNET'
        echo 'Detecting public IP for proper P2P connectivity'
        echo '========================================='
        
        # Detect public IP - Use manual override if set, otherwise let MetalGo auto-detect
        PUBLIC_IP=""
        PUBLIC_IP_FLAG=""
        
        # Method 1: Manual override via environment variable (HIGHEST PRIORITY)
        if [ -n "$METAL_PUBLIC_IP" ]; then
          if [[ "$METAL_PUBLIC_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            PUBLIC_IP="$METAL_PUBLIC_IP"
            PUBLIC_IP_FLAG="--public-ip=$PUBLIC_IP"
            echo "✅ Using manually specified public IP: $PUBLIC_IP"
            echo "   (Set via METAL_PUBLIC_IP environment variable)"
          else
            echo "⚠️  WARNING: METAL_PUBLIC_IP is set but invalid format: $METAL_PUBLIC_IP"
            echo "   Ignoring and using automatic detection..."
          fi
        fi
        
        if [ -z "$PUBLIC_IP_FLAG" ]; then
          echo "⚠️  Starting MetalGo without --public-ip flag"
          echo "⚠️  MetalGo will use built-in NAT traversal"
          echo "⚠️  For best results, set METAL_PUBLIC_IP=<loadbalancer-ip> from Akash Console"
        fi
        
        echo 'Starting MetalGo...'
        
        /usr/local/bin/metalgo \
          --network-id=mainnet \
          --http-host=0.0.0.0 \
          --http-port=9650 \
          --staking-port=9651 \
          --staking-host=0.0.0.0 \
          $PUBLIC_IP_FLAG \
          --log-level=info &
        
        METAL_PID=$!
        
        echo 'Waiting for MetalGo to initialize (30 seconds)...'
        sleep 30
        
        echo 'Waiting for API to be ready...'
        for i in {1..20}; do
          if curl -s --max-time 5 http://localhost:9650/ext/health > /dev/null 2>&1; then
            echo 'API is ready!'
            break
          fi
          echo "Waiting for API... attempt $i/20"
          sleep 15
        done
        
        echo 'Waiting for blockchain to bootstrap...'
        while true; do
          RESPONSE=$(curl -s --max-time 10 -X POST \
            -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"info.isBootstrapped","params":{"chain":"X"},"id":1}' \
            http://localhost:9650/ext/info 2>/dev/null)
          
          if echo "$RESPONSE" | jq -e '.result.isBootstrapped == true' > /dev/null 2>&1; then
            echo 'Bootstrap complete!'
            break
          fi
          echo 'Still bootstrapping... (this can take several minutes)'
          sleep 30
        done
        
        # Wait a bit more for P2P connections to establish
        echo 'Waiting for P2P connections to establish...'
        sleep 15
        
        # Get node information
        echo 'Retrieving node information...'
        NODE_INFO=$(curl -s -X POST -H 'Content-Type: application/json' \
          -d '{"jsonrpc":"2.0","method":"info.getNodeID","params":{},"id":1}' \
          http://localhost:9650/ext/info 2>/dev/null)
        
        NODE_ID=$(echo "$NODE_INFO" | jq -r '.result.nodeID // "N/A"' 2>/dev/null)
        BLS_KEY=$(echo "$NODE_INFO" | jq -r '.result.nodePOP.publicKey // "N/A"' 2>/dev/null)
        BLS_SIG=$(echo "$NODE_INFO" | jq -r '.result.nodePOP.proofOfPossession // "N/A"' 2>/dev/null)
        
        # Get peer information
        PEERS_INFO=$(curl -s -X POST -H 'Content-Type: application/json' \
          -d '{"jsonrpc":"2.0","method":"info.peers","params":{},"id":1}' \
          http://localhost:9650/ext/info 2>/dev/null)
        
        PEER_COUNT=$(echo "$PEERS_INFO" | jq -r '.result.numPeers // 0' 2>/dev/null)
        if [ -z "$PEER_COUNT" ] || [ "$PEER_COUNT" = "null" ]; then
          PEER_COUNT=0
        fi
        
        # Use the IP we detected and passed to MetalGo
        if [ -n "$PUBLIC_IP" ]; then
          ADVERTISED_IP="$PUBLIC_IP (explicitly set)"
        else
          # Fallback: Get IP that MetalGo detected
          NODE_IP_INFO=$(curl -s -X POST -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"info.getNodeIP","params":{},"id":1}' \
            http://localhost:9650/ext/info 2>/dev/null)
          DETECTED_IP=$(echo "$NODE_IP_INFO" | jq -r '.result.ip // empty' 2>/dev/null)
          
          if [ -n "$DETECTED_IP" ]; then
            ADVERTISED_IP="$DETECTED_IP (auto-discovered)"
          else
            ADVERTISED_IP="Check Akash Console for MetalLB IP"
          fi
        fi
        
        echo ""
        echo "========================================"
        echo "=== METAL MAINNET VALIDATOR SETUP DATA ==="
        echo "========================================"
        echo ""
        echo "Copy the following data to your Metal MAINNET dashboard:"
        echo ""
        echo "Node ID"
        echo "$NODE_ID"
        echo ""
        echo "Proof of Possession - Public Key"
        echo "$BLS_KEY"
        echo ""
        echo "Proof of Possession - Signature"
        echo "$BLS_SIG"
        echo ""
        echo "========================================"
        echo "=== NETWORK STATUS ==="
        echo "========================================"
        echo ""
        echo "Public IP: $ADVERTISED_IP"
        echo "Connected Peers: $PEER_COUNT"
        echo "Network: Metal Mainnet"
        echo "RPC Endpoint: http://<your-deployment-url>:9650"
        echo "P2P Port: 9651"
        echo ""
        echo "Explorer: https://explorer.metalblockchain.org/validators"
        echo "Search for your Node ID in the explorer to verify connectivity"
        echo ""
        echo "========================================"
        echo "=== MAINNET DEPLOYMENT COMPLETE ==="
        echo "========================================"
        echo ""
        
        if [ "$PEER_COUNT" -gt 0 ] 2>/dev/null; then
          echo "✅ SUCCESS: Node is connected to $PEER_COUNT peer(s)"
          echo "✅ Your node should appear as 'Connected' in the explorer"
        else
          echo "⚠️  WARNING: Node has 0 peers (may still be connecting)"
          echo "⚠️  Wait 5-10 minutes and check the explorer"
        fi
        
        echo ""
        echo "Keeping node running... (check logs for ongoing activity)"
        
        # Keep container running and show periodic status
        while true; do
          sleep 300  # Every 5 minutes
          CURRENT_PEERS=$(curl -s -X POST -H 'Content-Type: application/json' \
            -d '{"jsonrpc":"2.0","method":"info.peers","params":{},"id":1}' \
            http://localhost:9650/ext/info | jq -r '.result.numPeers // 0')
          echo "[$(date)] Status: Connected to $CURRENT_PEERS peer(s)"
        done
    
    expose:
      - port: 9650
        as: 9650
        to:
          - global: true
            ip: metal_endpoint
        proto: tcp
      - port: 9651  
        as: 9651
        to:
          - global: true
            ip: metal_endpoint
        proto: tcp

profiles:
  compute:
    metal-blockchain:
      resources:
        cpu:
          units: 2.0
        memory:
          size: 4Gi
        storage:
          - size: 120Gi

  placement:
    akash-providers:
      attributes:
        host: akash
        ip-lease: true
      pricing:
        metal-blockchain:
          denom: uakt
          amount: 100

deployment:
  metal-blockchain:
    akash-providers:
      profile: metal-blockchain
      count: 1
